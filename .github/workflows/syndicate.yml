name: Syndicate Posts

on:
  # Run after successful deployments to main
  push:
    branches:
      - main
    paths:
      - 'posts/**'
      - '.syndication.config.json'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual publications)'
        required: false
        type: boolean
        default: false
      force:
        description: 'Force re-syndication of already published posts'
        required: false
        type: boolean
        default: false
      post_id:
        description: 'Specific post ID to syndicate (optional)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  syndicate:
    runs-on: ubuntu-latest
    # Don't fail the workflow if syndication fails
    continue-on-error: true
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run syndication
        env:
          HASHNODE_API_TOKEN: ${{ secrets.HASHNODE_API_TOKEN }}
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
        run: |
          FLAGS=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            FLAGS="$FLAGS --force"
          fi
          if [ -n "${{ github.event.inputs.post_id }}" ]; then
            FLAGS="$FLAGS --post=${{ github.event.inputs.post_id }}"
          fi
          npm run syndicate -- $FLAGS

      - name: Commit updated state
        # Only commit if not in dry-run mode
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet .syndication-state.json; then
            echo "No state changes to commit"
          else
            git add .syndication-state.json
            git commit -m "chore: update syndication state [skip ci]"
            git push
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Syndication Failed';
            const body = `The syndication workflow failed on commit ${context.sha}.
            
            **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            Please check the logs and retry manually if needed.
            
            ## Troubleshooting Steps
            1. Check the workflow logs for specific error messages
            2. Verify API tokens are set correctly in repository secrets
            3. Check if platform APIs are accessible
            4. Review the .syndication.config.json for any misconfigurations
            5. Try running with --dry-run flag to test without publishing
            
            ## Manual Retry
            You can manually trigger the workflow from the Actions tab with custom parameters.`;
            
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'syndication,automated'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['syndication', 'automated', 'bug']
              });
            }
